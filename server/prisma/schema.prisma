generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Enums
enum Role {
  ADMIN
  USER
  ACCOUNTANT
  FINANCE
}

enum TransactionType {
  CREDIT
  DEBIT
}

/// Models
model User {
  id                   Int           @id @default(autoincrement())
  name                 String
  email                String?       @unique
  password             String?
  role                 Role          @default(USER)
  resetToken           String?
  resetTokenExpiry     DateTime?
  // Relations
  createdTransactions  Transaction[] @relation("CreatedTransactions") // transactions this user created
  employeeTransactions Transaction[] @relation("EmployeeTransactions") // transactions assigned to / done by this employee (optional)
  createdAt            DateTime      @default(now())
}

model Category {
  id            Int      @id @default(autoincrement())
  name          String
  parentId      Int?
  parent        Category?  @relation("Subcategories", fields: [parentId], references: [id], onDelete: Cascade)
  subcategories Category[] @relation("Subcategories")
  meta          Json?
  createdAt     DateTime   @default(now())

  // relations to Transaction
  transactions            Transaction[] @relation("CategoryTransactions") // primary category
  subcategoryTransactions Transaction[] @relation("SubcategoryTransactions") // used as subcategory

  @@index([name])
  @@unique([name, parentId]) // optional: prevents duplicate names at same level
}

// ---------------------------------------------
// ## 1. NEW MODEL ADDED ##
// This model represents the "bill" or "expectation of payment"
// ---------------------------------------------
model Invoice {
  id             Int       @id @default(autoincrement())
  invoiceNumber  String    @unique
  expectedAmount Decimal   @db.Decimal(18, 2)
  clientName     String?
  issuedAt       DateTime  @default(now())
  dueDate        DateTime?

  // Links to all payments (Transactions) received for this invoice
  payments       Transaction[] @relation("InvoicePayments")

  createdAt      DateTime      @default(now())

  // --- ADD THIS LINE ---
  externalId     String?   @unique // The ID from the OTHER backend (Django)

  @@index([invoiceNumber])
  // --- AND ADD THIS LINE ---
  @@index([externalId])
}

// ---------------------------------------------
// ## 2. TRANSACTION MODEL UPDATED ##
// We added 3 new fields and 1 new index
// ---------------------------------------------
model Transaction {
  id            Int             @id @default(autoincrement())
  type          TransactionType
  amount        Decimal         @db.Decimal(18, 2)
  categoryId    Int
  subcategoryId Int?
  note          String?
  date          DateTime        @default(now())
  employeeId    Int?            // if transaction is assigned to / done by a specific employee
  reference     String?
  extraDetails  Json?
  createdById   Int

  // --- NEW FIELDS ADDED HERE ---
  invoiceId          Int?     // Links to the Invoice (bill)
  invoice            Invoice? @relation("InvoicePayments", fields: [invoiceId], references: [id], onDelete: SetNull)
  reconciliationNote String?  // For your CA's "correction" or "leftover" note
  // --- END OF NEW FIELDS ---

  // relations
  category    Category  @relation("CategoryTransactions", fields: [categoryId], references: [id], onDelete: Restrict)
  subcategory Category? @relation("SubcategoryTransactions", fields: [subcategoryId], references: [id], onDelete: SetNull)
  createdBy   User      @relation("CreatedTransactions", fields: [createdById], references: [id], onDelete: Cascade)
  employee    User?     @relation("EmployeeTransactions", fields: [employeeId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([date])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([invoiceId]) // <-- NEW INDEX ADDED
}